<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnTrack | Máquinas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <link rel="stylesheet" href="./css/navbar.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .main-container { padding-top: 90px; }
        .page-header h1 { font-size: 1.75rem; font-weight: 600; }
        .machine-item { border: 1px solid #f0f0f0; border-radius: 0.8rem; margin-bottom: 1rem; background-color: #fff; box-shadow: none; transition: box-shadow 0.2s ease-in-out; }
        .machine-item:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .machine-header { display: flex; align-items: center; padding: 1.2rem 2rem; min-height: 80px; cursor: pointer; }
        .machine-image { width: 65px; height: 65px; border-radius: 12px; object-fit: cover; margin-right: 2rem; }
        .machine-info { flex-grow: 1; }
        .machine-info strong { display: block; font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .status-badge { padding: 0.4em 0.8em; border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: #fff; margin: 0 1rem; min-width: 80px; text-align: center; }
        .status-stable { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .chevron-icon { color: #6c757d; transition: transform 0.3s ease; }
        .machine-header[aria-expanded="true"] .chevron-icon { transform: rotate(180deg); }
        .machine-details { padding: 1.5rem; border-top: 1px solid #f0f0f0; }
        .details-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
        .btn-action-save { background-color: #dc3545; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 5px; font-weight: 500; }
        .btn-delete { background-color: #6c757d; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 5px; font-weight: 500; }
        .btn-add-component { background-color: #17a2b8; color: white; }
    </style>
</head>

<body onload="listarMaquinasPorEmpresas()" class="sidebar-collapsed">

    <div id="sidebar-container"></div>
    
    <div id="main-content">
        <div id="navbar-container"></div>
        
        <div class="container main-container">
            <div class="page-header">
                <h1>Máquinas</h1>
                <div class="d-flex gap-2 justify-content-end mb-3">
                    <button class="btn btn-outline-secondary">Todos os Status</button>
                    <button class="btn btn-outline-secondary">Todas as Garagens</button>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addMaquinaModal">
                        <i class="fas fa-plus me-2"></i>Adicionar Garagem
                    </button>
                </div>
            </div>
            <div id="listaMaquinas"></div>
        </div>
    </div>
    
    <div class="modal fade" id="addMaquinaModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <form id="formAddMaquina" onsubmit="salvarMaquina(event)">
                    <div class="modal-header">
                        <h5 class="modal-title">Cadastrar Nova Máquina</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="empresaId" value="">
                        <div class="mb-3">
                            <label for="idMaquina" class="form-label">ID da Máquina</label>
                            <input type="text" class="form-control" id="idMaquina" name="idMaquina" required>
                        </div>
                        <h6>Componentes</h6>
                        <div id="componentesContainer"></div>
                        <button class="btn btn-danger mt-2" type="button" onclick="adicionarComponente()">
                            <i class="fas fa-plus me-2"></i>Adicionar Componente
                        </button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteCompModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja excluir este componente?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteCompBtn">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja excluir esta máquina?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="./js/navbar.js"></script>
    
    <script>
        const idEmpresa = sessionStorage.ID_EMPRESA;
        let listaDeComponentesHardware = [];

        async function listarMaquinasPorEmpresas() {
            try {
                const resp = await fetch("/maquina/listar");
                listaDeComponentesHardware = await resp.json();
            } catch (error) {
                console.error("Erro ao carregar lista de componentes de hardware:", error);
            }

            const mockData = {
                statuses: ['stable', 'warning', 'error', 'stable', 'stable', 'stable'],
            };
            let mockIndex = 0;

            try {
                let respostaMaquinas = await fetch(`/maquina?idEmpresa=${idEmpresa}`);
                if (!respostaMaquinas.ok) throw new Error('Falha ao buscar máquinas');
                let jsonMaquinas = await respostaMaquinas.json();

                const lista = document.getElementById("listaMaquinas");
                lista.innerHTML = "";

                for (const maquina of jsonMaquinas) {
                    let respostaGaragens = await fetch(`/garagens/buscarGaragem/${maquina.fkGaragem}`);
                    if (!respostaGaragens.ok) throw new Error('Falha ao buscar garagem');
                    let jsonGaragem = await respostaGaragens.json();
                    const nomeGaragem = jsonGaragem.length > 0 ? jsonGaragem[0].nome : 'Garagem não encontrada';

                    const status = mockData.statuses[mockIndex % mockData.statuses.length] || 'stable';
                    const statusInfo = {
                        'stable': { text: 'STABLE', class: 'status-stable' },
                        'warning': { text: 'WARNING', class: 'status-warning' },
                        'error': { text: 'ERROR', class: 'status-error' }
                    };

                    let componentesHtml = (maquina.componentes || []).map(c => {
                        let options = `<option value="">Selecione</option>`;
                        listaDeComponentesHardware.forEach(comp => {
                            const isSelected = comp.idComponenteHardware == c.idComponenteHardware ? "selected" : "";
                            options += `<option value="${comp.idComponenteHardware}" ${isSelected}>${comp.nomeComponente} (${comp.unidadeMedida})</option>`;
                        });

                        return `
                            <div class="comp-row mb-2">
                                <input type="hidden" name="idComponenteHardware[]" value="${c.idComponenteHardware}">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-5"><select class="form-select" name="idComponente[]">${options}</select></div>
                                    <div class="col-md-3"><input type="number" step="any" class="form-control" name="parametroMin[]" placeholder="Mínimo" value="${c.parametroMin}"></div>
                                    <div class="col-md-3"><input type="number" step="any" class="form-control" name="parametroMax[]" placeholder="Máximo" value="${c.parametroMax}"></div>
                                    <div class="col-md-1"><button type="button" class="btn btn-sm btn-outline-danger" onclick="abrirModalExcluirComponente(${maquina.idMaquina}, ${c.idComponenteHardware})"><i class="fa-solid fa-trash"></i></button></div>
                                </div>
                            </div>`;
                    }).join("");

                    const machineItem = document.createElement("div");
                    machineItem.className = "machine-item";
                    machineItem.innerHTML = `
                        <div class="machine-header" data-bs-toggle="collapse" href="#collapse-${maquina.idMaquina}" role="button" aria-expanded="false" aria-controls="collapse-${maquina.idMaquina}">
                            <img src="./Images/garagem.svg" alt="Imagem da Máquina" class="machine-image">
                            <div class="machine-info">
                                <strong>Máquina ${nomeGaragem}</strong>
                            </div>
                            <span class="status-badge ${statusInfo[status].class}">${statusInfo[status].text}</span>
                            <i class="fas fa-chevron-down chevron-icon"></i>
                        </div>

                        <div class="collapse" id="collapse-${maquina.idMaquina}">
                            <div class="machine-details">
                                <form id="form-edit-maquina-${maquina.idMaquina}" onsubmit="salvarAlteracoesCard(event, ${maquina.idMaquina})">
                                    <h6>Componentes e Parâmetros</h6>
                                    ${maquina.componentes && maquina.componentes.length > 0 ? componentesHtml : '<p>Nenhum componente cadastrado.</p>'}
                                    
                                    <div id="novos-componentes-${maquina.idMaquina}" class="mt-3"></div>
                                    
                                    <button type="button" class="btn btn-sm btn-add-component mt-2" onclick="adicionarComponenteNoCard(${maquina.idMaquina})">
                                        <i class="fas fa-plus me-1"></i> Adicionar Componente
                                    </button>
                                    
                                    <div class="details-actions">
                                        <button type="button" class="btn-delete" onclick='abrirModalExclusao(${JSON.stringify(maquina)})'>
                                            <i class="fas fa-trash-alt me-1"></i> Excluir Máquina
                                        </button>
                                        <button type="submit" class="btn-action-save" id="btn-salvar-${maquina.idMaquina}" style="display: none;">
                                            <i class="fas fa-save me-1"></i> Salvar Alterações
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;

                    lista.appendChild(machineItem);
                    mockIndex++;

                    const form = document.getElementById(`form-edit-maquina-${maquina.idMaquina}`);
                    const campos = form.querySelectorAll('input, select');
                    campos.forEach(campo => {
                        campo.addEventListener('input', () => mostrarBotaoSalvar(maquina.idMaquina));
                    });
                }
            } catch (error) {
                console.error("Erro ao listar máquinas:", error);
                document.getElementById("listaMaquinas").innerHTML = `<div class="alert alert-danger">Não foi possível carregar as máquinas. Tente novamente mais tarde.</div>`;
            }
        }

        function mostrarBotaoSalvar(maquinaId) {
            const botao = document.getElementById(`btn-salvar-${maquinaId}`);
            if (botao) {
                botao.style.display = 'inline-block';
            }
        }

        async function adicionarComponente() {
            const container = document.getElementById("componentesContainer");
            const div = document.createElement("div");
            div.className = "comp-row mb-3 border p-2 rounded";
            let options = `<option value="">Selecione um Componente</option>`;
            listaDeComponentesHardware.forEach(c => {
                options += `<option value="${c.idComponenteHardware}">${c.nomeComponente} (${c.unidadeMedida})</option>`;
            });
            div.innerHTML = `
                <select class="form-select mb-2" name="idComponente[]">${options}</select>
                <div class="d-flex gap-2">
                    <input type="number" class="form-control" name="parametroMin[]" placeholder="Parâmetro Mínimo">
                    <input type="number" class="form-control" name="parametroMax[]" placeholder="Parâmetro Máximo">
                </div>
            `;
            container.appendChild(div);
        }

        function adicionarComponenteNoCard(maquinaId) {
            const container = document.getElementById(`novos-componentes-${maquinaId}`);
            const div = document.createElement("div");
            div.className = "comp-roww border p-2 rounded mb-2";

            let options = `<option value="">Selecione um Componente</option>`;
            listaDeComponentesHardware.forEach(c => {
                options += `<option value="${c.idComponenteHardware}">${c.nomeComponente} (${c.unidadeMedida})</option>`;
            });

            div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-5">
                    <select class="form-select" name="idComponenteNovo[]" required>${options}</select>
                </div>
                <div class="col-md-3">
                    <input type="number" step="any" class="form-control" name="parametroMinNovo[]" placeholder="Mínimo" required>
                </div>
                <div class="col-md-3">
                    <input type="number" step="any" class="form-control" name="parametroMaxNovo[]" placeholder="Máximo" required>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.comp-roww').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>`;
            container.appendChild(div);
            mostrarBotaoSalvar(maquinaId);
        }

        async function salvarMaquina(event) {
            event.preventDefault();
            const form = document.getElementById("formAddMaquina");
            const formData = new FormData(form);
            const idMaquina = formData.get("idMaquina");
            const idsComponentes = formData.getAll("idComponente[]");
            const minimos = formData.getAll("parametroMin[]");
            const maximos = formData.getAll("parametroMax[]");
            const componentes = idsComponentes.map((id, i) => ({
                idComponente: id,
                parametroMin: minimos[i],
                parametroMax: maximos[i]
            })).filter(c => c.idComponente);

            if (componentes.length === 0) {
                Swal.fire({ icon: "warning", title: "Atenção", text: "Adicione pelo menos um componente." });
                return;
            }

            const maquina = { idMaquina, idEmpresa, componentes };

            try {
                const response = await fetch("/maquina/adicionar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(maquina)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                Swal.fire({ icon: "success", title: "Sucesso!", text: "Máquina cadastrada com sucesso." });
                form.reset();
                listarMaquinasPorEmpresas();
                bootstrap.Modal.getInstance(document.getElementById("addMaquinaModal")).hide();
            } catch (err) {
                Swal.fire({ icon: "error", title: "Erro", text: err.message || "Não foi possível cadastrar a máquina." });
            }
        }

        let componenteParaExcluir = null;

        function abrirModalExcluirComponente(idMaquina, idComponente) {
            componenteParaExcluir = { idMaquina, idComponente };
            new bootstrap.Modal(document.getElementById("confirmDeleteCompModal")).show();
        }

        document.getElementById("confirmDeleteCompBtn").addEventListener("click", async () => {
            if (!componenteParaExcluir) return;
            const { idMaquina, idComponente } = componenteParaExcluir;
            try {
                const res = await fetch(`/maquina/excluirComponente/${idMaquina}/${idComponente}`, { method: "DELETE" });
                if (!res.ok) throw new Error("Erro ao excluir componente");
                bootstrap.Modal.getInstance(document.getElementById("confirmDeleteCompModal")).hide();
                listarMaquinasPorEmpresas();
                Swal.fire({ icon: "success", title: "Excluído", text: "O componente foi removido." });
            } catch (err) {
                Swal.fire({ icon: "error", title: "Erro", text: "Não foi possível excluir o componente." });
            }
        });

        async function salvarAlteracoesCard(event, maquinaId) {
            event.preventDefault();
            const form = document.getElementById(`form-edit-maquina-${maquinaId}`);
            if (!form) return;

            const rowsExistentes = form.querySelectorAll(".comp-row");
            const updates = Array.from(rowsExistentes).map(row => ({
                antigoId: row.querySelector("input[name='idComponenteHardware[]']").value,
                novoId: row.querySelector("select[name='idComponente[]']").value,
                parametroMin: row.querySelector("input[name='parametroMin[]']").value.trim(),
                parametroMax: row.querySelector("input[name='parametroMax[]']").value.trim()
            }));

            if (updates.some(u => !u.parametroMin || !u.parametroMax || !u.novoId)) {
                return Swal.fire({ icon: "error", title: "Campos obrigatórios", text: "Preencha todos os campos dos componentes existentes." });
            }

            const formData = new FormData(form);
            const novosComponentes = formData.getAll("idComponenteNovo[]")
                .map((id, i) => ({
                    idComponente: id,
                    parametroMin: formData.getAll("parametroMinNovo[]")[i],
                    parametroMax: formData.getAll("parametroMaxNovo[]")[i]
                }))
                .filter(c => c.idComponente && c.parametroMin && c.parametroMax);

            try {
                if (updates.length > 0) {
                    const resEditar = await fetch("/maquina/editar", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ updates })
                    });
                    if (!resEditar.ok) throw new Error("Erro ao editar componentes existentes");
                }

                if (novosComponentes.length > 0) {
                    const resAdd = await fetch("/maquina/adicionarComponente", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ idMaquina, componentes: novosComponentes })
                    });
                    if (!resAdd.ok) throw new Error("Erro ao adicionar novos componentes");
                }

                Swal.fire({ icon: "success", title: "Sucesso", text: "Máquina atualizada com sucesso!" });
                listarMaquinasPorEmpresas();

            } catch (err) {
                Swal.fire({ icon: "error", title: "Erro na edição", text: err.message });
            }
        }

        let maquinaSelecionada = null;

        function abrirModalExclusao(maquina) {
            maquinaSelecionada = maquina;
            new bootstrap.Modal(document.getElementById("deleteConfirmModal")).show();
        }

        document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
            if (!maquinaSelecionada) return;
            try {
                const response = await fetch(`/maquina/excluir/${maquinaSelecionada.idMaquina}`, { method: "DELETE" });
                if (!response.ok) throw new Error("Erro ao excluir máquina");
                Swal.fire({ icon: "success", title: "Excluído!", text: "A máquina foi excluída com sucesso." });
                listarMaquinasPorEmpresas();
                bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal")).hide();
            } catch (error) {
                Swal.fire({ icon: "error", title: "Erro", text: "Não foi possível excluir a máquina." });
            }
        });
    </script>

</body>
</html>