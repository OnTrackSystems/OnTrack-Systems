<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnTrack Systems - Monitoramento de Bilhetagem</title>

    <link rel="stylesheet" href="css/estilo-alerta.css">
    <link rel="stylesheet" href="css/estilo-padrao.css">

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

    <div class="container-dashboard">

        <header class="cabecalho-principal">
            <div class="logo-area">
                <h1>OnTrack <span style="font-weight: 300;">Systems - Chamados</span> </h1>
                <h1><span>Última atualizacao: <span id="ultimaAtt"></span></span></h1>
            </div>
        </header>

        <section class="grade-indicadores">
            <div class="card-padrao">
                <div class="titulo-indicador">MTTR (Tempo Médio de Reparo)</div>
                <div class="valor-indicador">12m 30s</div>
                <div class="sub-indicador status-text-green">↓ 15% mais rápido que ontem</div>
            </div>

            <div class="card-padrao">
                <div class="titulo-indicador">Média Semanal de Alertas</div>
                <div class="valor-indicador">142</div>
                <div class="sub-indicador">Alertas registrados nos últimos 7 dias</div>
            </div>

            <div class="card-padrao">
                <div class="titulo-indicador">Alertas Críticos Ativos</div>
                <div class="valor-indicador status-text-red">2</div>
                <div class="sub-indicador">Ação imediata necessária</div>
            </div>
        </section>

        <section class="secao-graficos">

            <div class="card-padrao">
                <div class="titulo-grafico">Alertas por Categoria</div>

                <div class="linha-categoria">
                    <div class="cabecalho-cat">
                        <span><strong>CPU</strong> (Processamento)</span>
                        <span>55% dos alertas</span>
                    </div>
                    <div class="fundo-progresso">
                        <div class="preenchimento-progresso status-bg-red" style="width: 55%;"></div>
                    </div>
                    <p style="font-size: 0.75rem; margin-top: 2px; opacity: 0.7;">Incidentes recorrentes de 'High Load'
                    </p>
                </div>

                <div class="linha-categoria">
                    <div class="cabecalho-cat">
                        <span><strong>Memória RAM</strong></span>
                        <span>30% dos alertas</span>
                    </div>
                    <div class="fundo-progresso">
                        <div class="preenchimento-progresso status-bg-yellow" style="width: 30%;"></div>
                    </div>
                </div>

                <div class="linha-categoria">
                    <div class="cabecalho-cat">
                        <span><strong>Disco / Storage</strong></span>
                        <span>15% dos alertas</span>
                    </div>
                    <div class="fundo-progresso">
                        <div class="preenchimento-progresso status-bg-blue" style="width: 15%;"></div>
                    </div>
                </div>
            </div>

            <div class="card-padrao">
                <div class="titulo-grafico">Severidade Atual</div>
                <p style="font-size: 0.8rem; margin-bottom: 15px; opacity: 0.7;">Classificação dos incidentes ativos</p>
                <div class="container-severidade">
                    <div class="estatistica-donut">
                        <div class="indicador-circulo border-status-red status-text-red">2</div>
                        <span>Crítico</span>
                    </div>
                    <div class="estatistica-donut">
                        <div class="indicador-circulo border-status-yellow status-text-yellow">5</div>
                        <span>Atenção</span>
                    </div>
                    <div class="estatistica-donut">
                        <div class="indicador-circulo border-status-green status-text-green">12</div>
                        <span>Info</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="secao-tabela">
            <div class="titulo-grafico">Detalhamento dos Incidentes</div>

            <div class="barra-filtros">
                <select id="filtro-severidade">
                    <option value="todos">Severidade: Todas</option>
                    <option value="critico">Crítico</option>
                    <option value="atencao">Atenção</option>
                    <option value="info">Informativo</option>
                </select>

                <select id="filtro-categoria">
                    <option value="todos">Categoria: Todas</option>
                    <option value="cpu">CPU</option>
                    <option value="ram">RAM</option>
                    <option value="disco">Disco</option>
                </select>

                <select id="filtro-garagem">
                    <option value="todos" selected>Local: Todos</option>
                </select>

                <button id="btn-limpar" class="btn-reset">Atualizar Lista</button>
            </div>

            <div style="overflow-x: auto;">
                <table id="tabela-alertas">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Severidade</th>
                            <th>Local</th>
                            <th>Categoria</th>
                            <th>Mensagem</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaFiller">

                    </tbody>
                </table>

            </div>
        </section>

        <section style="margin-bottom: 20px;">
            <div class="card-padrao">
                <div class="titulo-grafico">
                    <span>Comparativo de Incidentes (Semana x Semana)</span>
                    <span class="status-text-red"
                        style="font-size: 0.8rem; display: flex; align-items: center; gap: 5px;">
                        ↑ 8% Aumento Global <span style="opacity: 0.5;">| Por Componente</span>
                    </span>
                </div>
                <div id="grafico-comparativo"></div>
            </div>
        </section>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-container card-padrao">
            <div class="modal-header">
                <h2>Detalhes do Incidente</h2>
                <button class="fechar-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-meta"><strong>ID do Evento:</strong> <span id="modal-id-texto">#Gerando...</span></p>
                <p>O sistema detectou uma anomalia nos parâmetros monitorados. A equipe técnica foi notificada
                    automaticamente. (Lorem ipsum)</p>
                <br>
                <p>Recomenda-se verificar os logs do servidor para identificar a causa raiz e aplicar as correções
                    necessárias para restabelecer a normalidade do serviço.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-acao">Exportar Log</button>
                <button class="btn-reset fechar-modal-btn">Fechar</button>
            </div>
        </div>
    </div>


</body>

</html>
<script>
document.addEventListener('DOMContentLoaded', function() {


    const csvContent = `stop_id,stop_name,stop_lat,stop_lon
18849,Vila Madalena,-23.546498,-46.691141
18852,Jabaquara,-23.646033,-46.641028
18860,Ana Rosa,-23.581203,-46.638489
18861,Paraíso,-23.5754,-46.6407
18867,Anhangabaú,-23.5478,-46.6392
18868,Liberdade,-23.555211,-46.635581
18872,Luz,-23.5366,-46.6343
18879,Santana,-23.502716,-46.624716
18882,Tucuruvi,-23.480049,-46.603209
18884,Penha,-23.533594,-46.542944
18888,Artur Alvim,-23.540068,-46.484833
18895,Guaianases,-23.542298,-46.415633
18897,Itaim Paulista,-23.493989,-46.402304
18901,Calmon Viana,-23.525497,-46.332803
18908,Socorro,-23.66343,-46.71097
18910,Morumbi,-23.621519,-46.701657
18912,Vila Olímpia,-23.593185,-46.692871
18914,Amador Bueno,-23.5307,-46.983928
18921,Perus,-23.404054,-46.754465
18922,Jaraguá,-23.455502,-46.738483
18932,Rio Grande Da Serra,-23.742981,-46.392026
18942,Ipiranga,-23.582356,-46.59666
18944,Tatuapé,-23.5403,-46.5767
18951,Jardim Silveira,-23.523568,-46.893491
18960,Osasco,-23.527834,-46.776007
18962,Ceasa,-23.538372,-46.741543
18965,Pirituba,-23.488464,-46.726058
18966,Pinheiros,-23.566631,-46.703082
18975,Jundiai,-23.195643,-46.8719
18981,Estudantes,-23.515696,-46.18493
18987,Brás,-23.545461,-46.616228
19044,Campo Limpo,-23.648987,-46.758878
19045,Capão Redondo,-23.659955,-46.768691
301729,Terminal Jardim Britânia,-23.432142,-46.787093
1211339,Butantã,-23.571874,-46.708048
1211402,Terminal Morumbi,-23.58572,-46.724003
1707356,Terminal Campo Limpo,-23.630478,-46.773613
2113416,Terminal Casa Verde,-23.496071,-46.662431
2600672,Paulista,-23.555071,-46.662131
3014630,Grajaú,-23.736283,-46.697068
3014807,Terminal Grajaú,-23.736292,-46.696819
3305180,Metrô Alto Do Ipiranga,-23.602369,-46.61171
3305203,Gentil De Moura,-23.602801,-46.613745
3305845,Sacomã,-23.601192,-46.601963
3305881,Terminal Sacomã,-23.602998,-46.602819
3407130,Terminal Água Espraiada,-23.613618,-46.695232
3407190,Campo Belo,-23.618357,-46.682067
3515230,Jardim Romano,-23.485148,-46.386211
3609008,Terminal A. E. Carvalho,-23.517644,-46.475981
3702829,Metrô Conceição,-23.635232,-46.641543
4114459,Vila Aurora,-23.437612,-46.747275
4503923,Terminal João Dias,-23.643855,-46.733968
5306694,Moema,-23.603386,-46.661974
5614760,Terminal Parelheiros,-23.828237,-46.72682
6714568,Pça. Do Correio,-23.542315,-46.635676
6714588,Terminal Bandeira,-23.549173,-46.639109
6714591,Terminal Amaral Gurgel,-23.538547,-46.648454
7612124,São Miguel Paulista,-23.490494,-46.443699
7805208,Vila União,-23.60294,-46.515768
7805213,Jardim Planalto,-23.606046,-46.507963
7805216,Fazenda Da Juta,-23.611853,-46.487579
7805217,São Mateus,-23.612272,-46.477314
7805250,Terminal Sapopemba,-23.614045,-46.500996
8010164,Terminal Mercado,-23.547015,-46.628892
8914861,União De Vila Nova,-23.48373,-46.462619
9206171,Metrô Vila Mariana,-23.589293,-46.63526
9206443,Chácara Klabin,-23.59299,-46.630999
9206548,Hospital São Paulo,-23.598381,-46.645612
9505541,Vila Prudente,-23.584447,-46.581943
9607516,Terminal Vila Sônia,-23.590998,-46.736223
9607525,Vila Sônia,-23.591689,-46.735692
420013595,Terminal Jardim Ângela,-23.690869,-46.774134
450014023,Terminal Guarapiranga,-23.668588,-46.735464
530015503,Parque Ibirapuera,-23.579414,-46.661951
560009238,Terminal Varginha,-23.766793,-46.716431
600012461,Metrô Penha,-23.53293,-46.543309
640000512,Terminal Pirituba,-23.486848,-46.726591`;

    // Função para ler o CSV
    function parseCSV(csv) {
        const lines = csv.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            if (values.length === headers.length) {
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index].trim();
                });
                data.push(obj);
            }
        }
        return data;
    }

    // Variáveis de Elementos DOM
    const paradasData = parseCSV(csvContent);
    const filtroGaragem = document.getElementById('filtro-garagem');
    const filtroSeveridade = document.getElementById('filtro-severidade');
    const filtroCategoria = document.getElementById('filtro-categoria');
    const btnLimpar = document.getElementById('btn-limpar');
    const msgSemResultados = document.getElementById('msg-sem-resultados');

    // Mapeamento Nome -> ID 
    const mapaGaragemNomeId = {};
    
    // Popula o Select de Filtro e o Mapa
    paradasData.forEach(parada => {
        const option = document.createElement('option');
        option.value = parada.stop_id;
        option.textContent = parada.stop_name;
        filtroGaragem.appendChild(option);

     
        mapaGaragemNomeId[parada.stop_name] = parada.stop_id;
    });

 
    fetch("/chamados/getCallsFromBucket/").then(res => {
        res.json().then(JSON => {
            console.log(JSON);
            
            if (JSON.metadata && JSON.metadata.ultima_atualizacao) {
                document.getElementById("ultimaAtt").innerHTML = JSON.metadata.ultima_atualizacao;
            }

            const tableBody = document.getElementById("tabelaFiller"); 
            tableBody.innerHTML = "";

            let atuais = { cpu: 0, ram: 0, disco: 0 };

            JSON.dados.forEach(element => {
                
                // setando cor
                let cor = "green";
                let severidadeTexto = "Info";
                
                // Chave filto
                let filtroSeveridadeKey = "info"; 

                if (element.prioridade === "Highest" || element.prioridade === "High") {
                    cor = "red";
                    severidadeTexto = "Crítico";
                    filtroSeveridadeKey = "critico";
                } else if (element.prioridade === "Medium") {
                    cor = "yellow";
                    severidadeTexto = "Atenção";
                    filtroSeveridadeKey = "atencao";
                }

                // limpeza
                let local = element; 
                let msgLimpa = element.titulo;

                // Tratamento para "Garagem"
                if (element.titulo.includes("Garagem")) {
                    const partes = element.titulo.split("Garagem");
                    msgLimpa = partes[0].replace("-", "").trim();
                    local = partes[1].trim().replace(":", "").trim(); 
                }

                // Tratamento para Tags de Alerta
                if (element.titulo.includes("[ALERTA CRÍTICO]")) {
                    const partes = element.titulo.split("[ALERTA CRÍTICO]");
                    msgLimpa = partes[1] ? partes[1].replace("-", "").trim() : msgLimpa; 
                    if(msgLimpa.includes("Garagem")) { 
                         const subPartes = msgLimpa.split("Garagem");
                         msgLimpa = subPartes[0].replace("-", "").trim();
                         local = subPartes[1].trim().replace(":", "").trim();
                    }
                }
                if (element.titulo.includes("[ALERTA MÉDIO]")) {
                    const partes = element.titulo.split("[ALERTA MÉDIO]");
                    msgLimpa = partes[1] ? partes[1].replace("-", "").trim() : msgLimpa;
                    if(msgLimpa.includes("Garagem")) {
                         const subPartes = msgLimpa.split("Garagem");
                         msgLimpa = subPartes[0].replace("-", "").trim();
                         local = subPartes[1].trim().replace(":", "").trim();
                    }
                }

                // buscando id pelo nome
                let filtroGaragemID = "0";
                if (mapaGaragemNomeId[local]) {
                    filtroGaragemID = mapaGaragemNomeId[local];
                }

                let categoria = "Outros";
                let filtroCategoriaKey = "outros";

                if (element.titulo.includes("CPU")) {
                    categoria = "CPU";
                    filtroCategoriaKey = "cpu";
                    atuais.cpu++; 
                }
                else if (element.titulo.includes("RAM")) {
                    categoria = "RAM";
                    filtroCategoriaKey = "ram";
                    atuais.ram++;
                }
                else if (element.titulo.includes("Disco")) {
                    categoria = "Disco";
                    filtroCategoriaKey = "disco";
                    atuais.disco++;
                }

            
                const filler = `
                <tr data-severidade="${filtroSeveridadeKey}" data-categoria="${filtroCategoriaKey}" data-garagem="${filtroGaragemID}">
                    <td>#${element.id}</td>
                    <td><span class="status-badge status-${cor}">${severidadeTexto}</span></td>
                    <td>${local}</td>
                    <td>${categoria}</td>
                    <td>${msgLimpa}</td>
                    <td><button class="btn-detalhes">Detalhes</button></td>
                </tr>`;

                tableBody.innerHTML += filler;
            });

          
            renderizarGrafico(atuais);
            

            aplicarFiltros();

        }).catch(err => console.error(err));
    }).catch(err => console.error(err));



    function aplicarFiltros() {
        const severidade = filtroSeveridade.value;
        const categoria = filtroCategoria.value;
        const garagemId = filtroGaragem.value;
        
        const tabelaAlertas = document.getElementById('tabela-alertas'); // ID da tabela pai
        const linhasTabela = tabelaAlertas.querySelectorAll('tbody tr'); // Pega as linhas geradas
        
        let resultadosEncontrados = 0;

        linhasTabela.forEach(linha => {
            const linhaSev = linha.getAttribute('data-severidade');
            const linhaCat = linha.getAttribute('data-categoria');
            const linhaGar = linha.getAttribute('data-garagem');

            const filtroSevOK = severidade === 'todos' || linhaSev === severidade;
            const filtroCatOK = categoria === 'todos' || linhaCat === categoria;
            const filtroGarOK = garagemId === 'todos' || linhaGar === garagemId;

            if (filtroSevOK && filtroCatOK && filtroGarOK) {
                linha.style.display = '';
                resultadosEncontrados++;
            } else {
                linha.style.display = 'none';
            }
        });

        if (resultadosEncontrados === 0 && msgSemResultados) {
            msgSemResultados.style.display = 'block';
        } else if (msgSemResultados) {
            msgSemResultados.style.display = 'none';
        }
    }

    // Listeners
    filtroSeveridade.addEventListener('change', aplicarFiltros);
    filtroCategoria.addEventListener('change', aplicarFiltros);
    filtroGaragem.addEventListener('change', aplicarFiltros);
    
    if(btnLimpar) {
        btnLimpar.addEventListener('click', function() {
            filtroSeveridade.value = 'todos';
            filtroCategoria.value = 'todos';
            filtroGaragem.value = 'todos';
            aplicarFiltros();
        });
    }


    function renderizarGrafico(atuais) {
        function simularPassado(valorAtual) {
            if (valorAtual === 0) return Math.floor(Math.random() * 3);
            return Math.floor(valorAtual * (0.7 + Math.random() * 0.6));
        }

        let anteriores = {
            cpu: simularPassado(atuais.cpu),
            ram: simularPassado(atuais.ram),
            disco: simularPassado(atuais.disco)
        };

        var options = {
            series: [{
                name: 'Semana Anterior',
                data: [anteriores.cpu, anteriores.ram, anteriores.disco]

            }, {
                name: 'Semana Atual',
                data: [atuais.cpu, atuais.ram, atuais.disco]
            }],
            chart: {
                type: 'bar',
                height: 250,
                toolbar: { show: false },
                fontFamily: 'Arial, sans-serif'
            },
            colors: ['#dc3545', '#ffc107'],
            plotOptions: {
                bar: { horizontal: false, columnWidth: '50%', borderRadius: 4 }
            },
            dataLabels: { enabled: false },
            stroke: { show: true, width: 2, colors: ['transparent'] },
            xaxis: { categories: ['CPU', 'RAM', 'Disco'] },
            yaxis: { title: { text: 'Alertas' } }
        };

        if(document.querySelector("#grafico-comparativo")) {
            document.querySelector("#grafico-comparativo").innerHTML = "";
            var chart = new ApexCharts(document.querySelector("#grafico-comparativo"), options);
            chart.render();
        }
    }
});
</script>