<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnTrack - Visão Global</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./css/navbar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.2/dist/apexcharts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-red: #dc3545;
            --primary-red-darker: #b02a37;
            --sidebar-text: #ffffff;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 80px;
            --navbar-height: 70px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* --- SIDEBAR CUSTOMIZADA (Seu Código) --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background-color: var(--primary-red);
            color: var(--sidebar-text);
            padding: 1.5rem 1rem;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 1031;
            overflow-x: hidden;
            white-space: nowrap;
            /* Impede quebra de texto na animação */
        }

        .sidebar-header {
            margin-bottom: 2rem;
            cursor: pointer;
        }

        .sidebar-header .logo {
            color: var(--sidebar-text);
            font-size: 1.5rem;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding-left: 0.5rem;
        }

        .logo-text {
            margin-left: 0.75rem;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav .nav-link {
            color: var(--sidebar-text);
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .sidebar-nav .nav-link:hover,
        .sidebar-nav .nav-link.active {
            background-color: var(--primary-red-darker);
            color: var(--sidebar-text);
        }

        .nav-link-text {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar-nav .nav-link i {
            width: 25px;
            text-align: center;
            font-size: 1.1rem;
        }


        body.sidebar-collapsed #sidebar {
            width: var(--sidebar-collapsed-width);
        }

        body.sidebar-collapsed .logo-text,
        body.sidebar-collapsed .nav-link-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
            pointer-events: none;
        }


        .navbar {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 0.5rem 1.5rem;
            z-index: 1030;
            position: fixed;
            top: 0;
            right: 0;
            height: var(--navbar-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding-left: calc(var(--sidebar-width) + 1.5rem);
            transition: padding-left 0.3s ease-in-out;
        }

        body.sidebar-collapsed .navbar {
            padding-left: calc(var(--sidebar-collapsed-width) + 1.5rem);
        }

        #sidebar-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: #333;
            padding: 5px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
        }

        #main-content {
            padding-top: calc(var(--navbar-height) + 20px);
            padding-left: var(--sidebar-width);
            padding-right: 0;
            transition: padding-left 0.3s ease-in-out;
            min-height: 100vh;
            background-color: #f8fafc;
        }

        body.sidebar-collapsed #main-content {
            padding-left: var(--sidebar-collapsed-width);
        }

        @media (max-width: 992px) {
            #sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }

            body.sidebar-open #sidebar {
                transform: translateX(0);
            }

            #main-content,
            body.sidebar-collapsed #main-content {
                padding-left: 0;
            }

            .navbar,
            body.sidebar-collapsed .navbar {
                padding-left: 1.5rem;
                width: 100%;
            }

            #sidebar-toggle {
                display: block;
            }
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .apexcharts-tooltip {
            background: #fff;
            border-color: #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<div id="sidebar-container"></div>
<nav class="navbar">
    <div style="display: flex; align-items: center;">
        <button class="btn" type="button" id="sidebar-toggle">
            <i class="fas fa-bars fa-lg"></i>
        </button>
        <h1 class="text-xl font-bold text-slate-800 ml-4 hidden sm:block">Visão Global da Infraestrutura</h1>
    </div>

    <div style="display: flex; align-items: center; gap: 20px;">
        <a href="#" style="color: #64748b;"><i class="fas fa-bell fa-lg"></i></a>
        <img src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User Avatar" class="user-avatar">
    </div>
</nav>

<div id="main-content">
    <div class="p-6 md:p-8">

        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">Monitoramento em Tempo Real</h2>
                <p class="text-slate-500 text-sm">Última atualização: Hoje, 14:30h</p>
            </div>
            <div class="flex items-center gap-3">
                <div
                    class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-50 transition-colors text-sm font-medium text-slate-700 shadow-sm">
                    <i data-lucide="globe" class="w-4 h-4 text-indigo-500"></i>
                    Todas as Garagens
                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 text-slate-400"></i>
                </div>
                <div class="flex bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                    <button
                        class="px-3 py-1.5 text-xs font-semibold rounded-md bg-slate-100 text-slate-800">24h</button>
                    <button
                        class="px-3 py-1.5 text-xs font-semibold rounded-md text-slate-500 hover:bg-slate-50">7d</button>
                </div>
                <button class="p-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-sm transition-colors">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div
                class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Probabilidade de Falha</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-1">14.8%</h3>
                    </div>
                    <div class="p-2 bg-rose-50 rounded-lg text-rose-600"><i data-lucide="activity" class="w-6 h-6"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="flex items-center font-semibold text-rose-600 bg-rose-50 px-2 py-0.5 rounded mr-2">
                        <i data-lucide="arrow-up-right" class="w-3 h-3 mr-1"></i> +4.2%
                    </span>
                    <span class="text-slate-400 text-xs">Média Global (Pico)</span>
                </div>
            </div>

            <div
                class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-amber-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Horário de Pico</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-1">19:00h</h3>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-amber-600"><i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="flex items-center font-semibold text-amber-600 bg-amber-50 px-2 py-0.5 rounded mr-2">
                        <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i> Crítico
                    </span>
                    <span class="text-slate-400 text-xs">Stress sistêmico</span>
                </div>
            </div>

            <div
                class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Uso de CPU (Média)</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-1">85%</h3>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="cpu" class="w-6 h-6"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="flex items-center font-semibold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded mr-2">
                        <i data-lucide="arrow-up-right" class="w-3 h-3 mr-1"></i> +12%
                    </span>
                    <span class="text-slate-400 text-xs">Previsão no pico</span>
                </div>
            </div>

            <div
                class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-red-600"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Garagens em Alerta</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-1">3</h3>
                    </div>
                    <div class="p-2 bg-red-50 rounded-lg text-red-600"><i data-lucide="siren" class="w-6 h-6"></i></div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="flex items-center font-semibold text-red-600 bg-red-50 px-2 py-0.5 rounded mr-2">
                        <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> Ação
                    </span>
                    <span class="text-slate-400 text-xs">Total: 12 garagens</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm min-w-0 flex flex-col">
                <div class="p-6 border-b border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-5 h-5 text-indigo-600"></i>
                                Risco de Falha vs. Carga (Global)
                            </h2>
                            <p class="text-sm text-slate-500 mt-1">Correlação entre processamento e probabilidade de
                                falha.</p>
                        </div>
                    </div>
                </div>
                <div class="flex-1 p-4 relative min-h-[350px]">
                    <div id="correlationChart" class="absolute inset-0 w-full h-full"></div>
                </div>
            </div>

            <div
                class="lg:col-span-1 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden min-w-0 h-[450px]">
                <div class="p-5 border-b border-slate-100 bg-slate-50">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="list-ordered" class="w-5 h-5 text-rose-600"></i>
                        Garagens Críticas
                    </h3>
                    <p class="text-xs text-slate-500 mt-1">Clique para ver detalhes específicos</p>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                    <div
                        class="flex items-center justify-between p-3 bg-rose-50 rounded-lg border border-rose-100 hover:bg-rose-100 cursor-pointer transition-colors group">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-rose-200 text-rose-700 flex items-center justify-center font-bold text-xs">
                                01</div>
                            <div>
                                <p class="font-bold text-slate-800 group-hover:text-rose-700">Garagem Zona Sul</p>
                                <p class="text-xs text-slate-500">Swap: <span class="font-bold text-rose-600">98%</span>
                                    | CPU: 92%</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-rose-400"></i>
                    </div>
                    <div
                        class="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors group">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold text-xs">
                                02</div>
                            <div>
                                <p class="font-bold text-slate-800 group-hover:text-indigo-600">Garagem Leste</p>
                                <p class="text-xs text-slate-500">Swap: <span
                                        class="font-bold text-amber-600">85%</span> | CPU: 78%</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                    </div>
                    <div
                        class="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors group">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold text-xs">
                                03</div>
                            <div>
                                <p class="font-bold text-slate-800 group-hover:text-indigo-600">Garagem SP-03</p>
                                <p class="text-xs text-slate-500">Swap: <span
                                        class="font-bold text-amber-600">82%</span> | CPU: 75%</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                    </div>
                    <div
                        class="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors group opacity-75">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold text-xs">
                                04</div>
                            <div>
                                <p class="font-bold text-slate-800">Garagem Norte</p>
                                <p class="text-xs text-slate-500">Swap: 20%</p>
                            </div>
                        </div>
                        <div class="px-2 py-1 rounded bg-emerald-100 text-emerald-700 text-[10px] font-bold">OK</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm min-w-0 flex flex-col">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="cpu" class="w-4.5 h-4.5 text-indigo-600"></i>
                        Média de CPU (Previsão)
                    </h3>
                    <div class="text-xs font-semibold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">6h</div>
                </div>
                <div class="flex-1 p-4 relative min-h-[250px]">
                    <div id="cpuChart" class="absolute inset-0 w-full h-full"></div>
                </div>
            </div>

            <!-- HEATMAP -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col min-w-0">
                <div class="p-6 border-b border-slate-100">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="clock" class="w-4.5 h-4.5 text-slate-600"></i>
                        Janela de Risco Sistêmico (24h)
                    </h3>
                </div>
                <div id="heatmap-strip" class="flex-1 p-6 flex flex-col justify-center"></div>
            </div>
        </div>

    </div>
</div>

<script>
    lucide.createIcons();

    const trendData = {
        times: [12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23].map(h => `${h}:00`),
        failProbabilities: [10, 12, 15, 18, 25, 30, 75, 85, 60, 35, 30, 25],
        systemLoad: [40, 50, 60, 70, 80, 90, 130, 150, 110, 70, 60, 50]
    };
    const cpuData = [55, 60, 75, 85, 92, 70, 65];
    const cpuLabels = ['15h', '16h', '17h', '18h', '19h', '20h', '21h'];

    const commonOptions = {
        chart: {
            height: '100%',
            width: '100%',
            toolbar: { show: false },
            zoom: { enabled: false },
            parentHeightOffset: 0
        },
        grid: { padding: { top: 0, right: 0, bottom: 0, left: 10 } }
    };

    // Render Correlation Chart
    const renderCorrelationChart = () => {
        const options = {
            ...commonOptions,
            chart: { ...commonOptions.chart, type: 'line' },
            series: [
                { name: 'Carga Sistema', type: 'column', data: trendData.systemLoad },
                { name: 'Prob. Falha (%)', type: 'area', data: trendData.failProbabilities }
            ],
            xaxis: { categories: trendData.times, labels: { style: { colors: '#64748b' } }, axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: [
                {
                    seriesName: 'Prob. Falha (%)',
                    axisTicks: { show: true }, axisBorder: { show: true, color: '#f43f5e' },
                    labels: { style: { colors: '#f43f5e' }, formatter: (val) => `${val.toFixed(0)}%` },
                    title: { text: "Falha (%)", style: { color: '#f43f5e', fontSize: '10px' } },
                    min: 0, max: 100
                },
                {
                    seriesName: 'Carga Sistema',
                    opposite: true,
                    axisTicks: { show: true }, axisBorder: { show: true, color: '#94a3b8' },
                    labels: { style: { colors: '#94a3b8' } },
                    title: { text: "Carga", style: { color: '#94a3b8', fontSize: '10px' } },
                    min: 0, max: 200
                }
            ],
            colors: ['#cbd5e1', '#f43f5e'],
            stroke: { width: [0, 3], curve: 'smooth' },
            fill: { opacity: [1, 0.2], gradient: { inverseColors: false, shade: 'light', type: "vertical", opacityFrom: 0.7, opacityTo: 0.05 } },
            dataLabels: { enabled: false },
            legend: { show: false },
            grid: { borderColor: '#e2e8f0', strokeDashArray: 3, padding: { left: 10, right: 0 } }
        };
        new ApexCharts(document.querySelector("#correlationChart"), options).render();
    };

    // Render CPU Chart
    const renderCpuChart = () => {
        const options = {
            ...commonOptions,
            chart: { ...commonOptions.chart, type: 'area' },
            series: [{ name: 'Uso Médio CPU', data: cpuData }],
            xaxis: { categories: cpuLabels, labels: { style: { colors: '#64748b' } }, axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: { labels: { style: { colors: '#64748b' }, formatter: (val) => `${val.toFixed(0)}%` }, min: 0, max: 100 },
            colors: ['#6366f1'],
            stroke: { width: 3, curve: 'smooth' },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.05, stops: [0, 90, 100] } },
            dataLabels: { enabled: false },
            grid: { borderColor: '#f1f5f9', strokeDashArray: 3, padding: { left: 0, right: 0, bottom: 0 } }
        };
        new ApexCharts(document.querySelector("#cpuChart"), options).render();
    };

    // Render Heatmap
    const renderHeatmapStrip = () => {
        const hours = Array.from({ length: 24 }, (_, i) => i);
        const getIntensity = (h) => {
            if (h >= 18 && h <= 20) return 4;
            if (h >= 16 && h <= 17) return 3;
            if (h >= 7 && h <= 10) return 2;
            return 1;
        };
        const colors = ['bg-slate-100', 'bg-emerald-200', 'bg-amber-200', 'bg-orange-400', 'bg-rose-500'];
        const strips = hours.map(h => {
            const intensity = getIntensity(h);
            const isCurrentHour = h === 19;
            const currentHourClass = isCurrentHour ? 'border-2 border-slate-900 shadow-md scale-110 z-10' : '';
            return `<div class="flex-1 relative group h-12"><div class="h-full rounded-sm ${colors[intensity]} transition-transform hover:scale-y-110 cursor-help ${currentHourClass}" style="margin-bottom: 2px;"></div><div class="opacity-0 group-hover:opacity-100 absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded pointer-events-none whitespace-nowrap z-30 shadow-lg">${String(h).padStart(2, '0')}:00h</div></div>`;
        }).join('');
        document.getElementById('heatmap-strip').innerHTML = `<div class="flex gap-0.5 w-full mb-1 items-end">${strips}</div><div class="flex justify-between text-[10px] text-slate-500 font-medium mt-1"><span>00h</span><span>06h</span><span>12h</span><span>18h</span><span>23h</span></div>`;
    };

    async function puxarJson() {
        try {
            let respostaJsonpreditiva = await fetch(`/preditiva/JsonPreditiva`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!respostaJsonpreditiva.ok) {
                console.error(await respostaJsonpreditiva.text());
                return;
            }

            let JsonPreditiva = await respostaJsonpreditiva.json();
            console.log(JsonPreditiva);
        } catch (e) {
            console.error("Erro ao carregar dados da garagem:", e);
        }
    }


    renderCorrelationChart();
    renderCpuChart();
    renderHeatmapStrip();
    puxarJson();

</script>
<script src="./js/navbar.js"></script>
</body>
</html>