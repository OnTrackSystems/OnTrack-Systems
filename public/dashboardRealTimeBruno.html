<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Monitoramento de Servidor</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s, stroke 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .transition-height {
            transition: max-height 0.28s ease;
        }
    </style>
</head>

<body class="font-display bg-gray-100">
    <div class="flex h-screen">

        <aside class="w-64 flex-shrink-0 bg-white flex flex-col shadow-lg">
            <div class="p-6 text-2xl font-bold text-textPrimary border-b border-border">
                On Track<span class="text-danger">.</span>
            </div>

            <nav class="flex-grow p-4 space-y-2">

                <div>
                    <button id="dashboardBtn"
                        class="w-full flex items-center justify-between gap-3 px-4 py-2 rounded-lg bg-danger/10 text-danger font-semibold hover:bg-danger/20 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined">dashboard</span>
                            Dashboard
                        </div>
                        <span id="dashboardArrow"
                            class="material-symbols-outlined text-sm transition-transform duration-200">expand_more</span>
                    </button>

                    <div id="dashboardMenu" class="overflow-hidden max-h-0 transition-height">
                        <a href="dashboard-analytics.html"
                            class="block px-8 py-2 text-sm text-textSecondary hover:text-danger hover:bg-gray-50">Analytics</a>
                        <a href="dashboard-sales.html"
                            class="block px-8 py-2 text-sm text-textSecondary hover:text-danger hover:bg-gray-50">Sales</a>
                        <a href="dashboard-reports.html"
                            class="block px-8 py-2 text-sm text-textSecondary hover:text-danger hover:bg-gray-50">Reports</a>
                    </div>
                </div>

                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-textSecondary hover:bg-gray-200 transition-colors"
                    href="servidores.html">
                    <span class="material-symbols-outlined">dvr</span> Servidores
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-textSecondary hover:bg-gray-200 transition-colors"
                    href="#">
                    <span class="material-symbols-outlined">warning</span> Alertas
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-textSecondary hover:bg-gray-200 transition-colors"
                    href="historico.html">
                    <span class="material-symbols-outlined">history</span> Histórico
                </a>
            </nav>

            <div class="p-4 border-t border-border">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-textSecondary hover:bg-gray-200 transition-colors"
                    href="#">
                    <span class="material-symbols-outlined">logout</span> Sair
                </a>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-textPrimary">Dashboard de Monitoramento</h1>
                <p class="text-textSecondary mt-1">Visão objetiva do estado dos seus componentes de servidor.</p>
            </header>

            <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8"></div>

            <div id="external-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">

                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md bg-white">
                    <div class="bg-success text-white text-center py-2 font-semibold text-lg">
                        Padrão Operacional
                    </div>
                    <div class="bg-white p-4 flex flex-col items-center justify-center">
                        <p class="text-lg font-semibold text-textPrimary mb-1">Normal</p>

                        <div class="flex flex-col items-center mt-4 mb-6">
                            <span class="material-symbols-outlined text-success text-4xl mb-2">schedule</span>
                            <p class="text-sm font-semibold text-textPrimary">Hoje é Segunda — Carga histórica alta</p>
                            <p class="text-sm text-textSecondary mt-1">Horário atual costuma apresentar maior volume de
                                dados</p>
                        </div>

                        <button onclick="showReport('Padrão Operacional')"
                            class="bg-success text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Exibir Relatório
                        </button>

                    </div>
                </div>

                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md bg-white">
                    <div class="bg-success text-white text-center py-2 font-semibold text-lg">
                        Ônibus Ativos
                    </div>
                    <div class="bg-white p-4 flex flex-col items-center justify-center">
                        <p class="text-lg font-semibold text-textPrimary mb-1">Normal</p>
                        <p class="text-sm text-textSecondary mb-2">Última atualização 19/11/2025, 09:24:07</p>

                        <div class="flex flex-col items-center mt-0 mb-4">
                            <p class="text-5xl font-extrabold leading-tight -mt-1">
                                15
                            </p>

                            <p class="text-sm font-semibold text-textPrimary mt-0">ônibus ativos</p>
                            <p class="text-sm text-textSecondary mt-1">Média para este horário: 14</p>
                        </div>

                        <button onclick="showReport('Ônibus Ativos')"
                            class="bg-success text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Exibir Relatório
                        </button>

                    </div>
                </div>

                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md bg-white">
                    <div class="bg-danger text-white text-center py-2 font-semibold text-lg">
                        Comparação Carga
                    </div>
                    <div class="bg-white p-4 flex flex-col items-center justify-center">
                        <p class="text-lg font-semibold text-textPrimary mb-1">Crítico</p>
                        <p class="text-sm text-textSecondary mb-4">Última atualização 19/11/2025, 09:24:07</p>

                        <div class="flex flex-col items-center mt-4 mb-6">
                            <p class="text-4xl font-extrabold text-danger flex items-center gap-1">
                                +35%
                                <span class="material-symbols-outlined text-4xl">arrow_upward</span>
                            </p>
                            <p class="text-sm text-textSecondary mt-1">Acima do esperado</p>
                        </div>

                        <button onclick="showReport('Comparação de Carga')"
                            class="bg-success text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Exibir Relatório
                        </button>

                    </div>
                </div>
            </div>

            <div id="report-modal" class="hidden modal">
                <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-lg p-6">
                    <h3 id="modal-title" class="text-xl font-bold mb-4 text-textPrimary"></h3>
                    <table class="w-full border border-gray-200 rounded-lg mb-4">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left px-4 py-2">Data/Hora</th>
                                <th class="text-left px-4 py-2">Uso (%)</th>
                                <th class="text-left px-4 py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="modal-table-body"></tbody>
                    </table>
                    <button onclick="closeModal()"
                        class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Fechar</button>
                </div>
            </div>

            <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </main>
    </div>

    <script>

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        success: "#10B981",
                        warning: "#F59E0B",
                        danger: "#DC2626",
                        surface: "#FFFFFF",
                        border: "#E5E7EB",
                        textPrimary: "#111827",
                        textSecondary: "#6B7280",
                    },
                    fontFamily: { display: ["Inter", "sans-serif"] },
                },
            },
        };

        let activeComponents = [];
        const components = ["CPU", "RAM", "Disco", "Rede"];
        const yAxisMax = {
            CPU: 85,
            RAM: 70,
            Disco: 80,
            Rede: 90
        };
        const history = { CPU: [], RAM: [], Disco: [], Rede: [] };
        const MOCK_HISTORY = {
            CPU: [
                { time: "2025-11-01 09:00", value: 28 },
                { time: "2025-11-01 10:00", value: 35 },
                { time: "2025-11-01 11:00", value: 42 },
                { time: "2025-11-01 12:00", value: 50 },
                { time: "2025-11-01 13:00", value: 47 },
                { time: "2025-11-01 14:00", value: 93 },
                { time: "2025-11-01 15:00", value: 70 },
                { time: "2025-11-01 16:00", value: 77 },
                { time: "2025-11-01 17:00", value: 80 },
                { time: "2025-11-01 18:00", value: 46 },
            ],
            RAM: [
                { time: "2025-11-01 09:00", value: 62 },
                { time: "2025-11-01 10:00", value: 60 },
                { time: "2025-11-01 11:00", value: 78 },
                { time: "2025-11-01 12:00", value: 64 },
                { time: "2025-11-01 13:00", value: 66 },
                { time: "2025-11-01 14:00", value: 79 },
                { time: "2025-11-01 15:00", value: 71 },
                { time: "2025-11-01 16:00", value: 68 },
                { time: "2025-11-01 17:00", value: 95 },
                { time: "2025-11-01 18:00", value: 63 },
            ],
            Disco: [
                { time: "2025-11-01 09:00", value: 22 },
                { time: "2025-11-01 10:00", value: 25 },
                { time: "2025-11-01 11:00", value: 28 },
                { time: "2025-11-01 12:00", value: 30 },
                { time: "2025-11-01 13:00", value: 33 },
                { time: "2025-11-01 14:00", value: 91 },
                { time: "2025-11-01 15:00", value: 89 },
                { time: "2025-11-01 16:00", value: 34 },
                { time: "2025-11-01 17:00", value: 76 },
                { time: "2025-11-01 18:00", value: 38 },
            ],
            Rede: [
                { time: "2025-11-01 09:00", value: 12 },
                { time: "2025-11-01 10:00", value: 15 },
                { time: "2025-11-01 11:00", value: 18 },
                { time: "2025-11-01 12:00", value: 60 },
                { time: "2025-11-01 13:00", value: 83 },
                { time: "2025-11-01 14:00", value: 25 },
                { time: "2025-11-01 15:00", value: 28 },
                { time: "2025-11-01 16:00", value: 96 },
                { time: "2025-11-01 17:00", value: 74 },
                { time: "2025-11-01 18:00", value: 22 },
            ],
        };

        const charts = [];
        let gridCount = 4;

        function generateUsage() {
            return Math.floor(Math.random() * 100);
        }

        function generateNetworkMB() {
            return (Math.random() * 120).toFixed(1);
        }


        function getStatus(usage) {
            if (usage < 70) return { text: "Normal", color: "success" };
            if (usage < 90) return { text: "Alerta", color: "warning" };
            return { text: "Crítico", color: "danger" };
        }

        function addHistory(name, value) {
            const now = new Date();
            const timestamp = now.toLocaleString();
            history[name].push({ time: timestamp, value });
            if (history[name].length > 10) history[name].shift();
        }

        function createKPI(name, usage) {
            const status = getStatus(usage);
            const dashArray = `${usage}, 100`;
            const colorClasses = {
                success: "bg-success text-white",
                warning: "bg-warning text-white",
                danger: "bg-danger text-white",
            };
            const lastUpdate = history[name].length
                ? history[name][history[name].length - 1].time
                : "—";

            return `
    <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md">
      <div class="${colorClasses[status.color]} text-center py-2 font-semibold text-lg">${name}</div>
      <div class="bg-white p-4 flex flex-col items-center justify-center">
        <p class="text-lg font-semibold text-textPrimary mb-1">${status.text}</p>
        <p class="text-sm text-textSecondary mb-4">Última atualização ${lastUpdate}</p>
        <div class="relative w-24 h-24 mb-3">
          <svg class="w-full h-full" viewBox="0 0 36 36">
            <path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"/>
            <path class="progress-ring__circle text-${status.color}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-dasharray="${dashArray}" stroke-linecap="round" stroke-width="3"/>
          </svg>
          <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
            <span class="text-2xl font-bold text-textPrimary">
  ${name === "Rede" ? usage + " MB/s" : usage + "%"}
</span>

          </div>
        </div>
        <button onclick="showReport('${name}')" class="bg-${status.color} text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition">
          Exibir Relatório
        </button>
      </div>
    </div>
  `;
        }

        function renderKPIs() {
            const container = document.getElementById("kpi-container");
            container.innerHTML = "";
            components.forEach((c) => {
                const usage = (c === "Rede") ? generateNetworkMB() : generateUsage();
                addHistory(c, usage);
                container.innerHTML += createKPI(c, usage);
            });
        }

        function generateRandomKpiHistory(label) {
            const history = [];
            for (let i = 0; i < 10; i++) {
                history.push({
                    timestamp: new Date(Date.now() - i * 60000).toLocaleTimeString("pt-BR"),
                    value: Number((Math.random() * 100).toFixed(1)) // valor aleatório %
                });
            }
            return history.reverse();
        }


        function showReport(name) {
            const modal = document.getElementById("report-modal");
            const title = document.getElementById("modal-title");
            const tbody = document.getElementById("modal-table-body");

            if (!modal || !title || !tbody) return;

            title.textContent = `Relatório de ${name}`;

            const ths = modal.querySelectorAll("th");
            if (ths && ths.length >= 2) {
                ths[1].textContent = (name === "Rede") ? "Uso (MB/s)" : "Uso (%)";
            }

            let rows = [];

            if (typeof MOCK_HISTORY !== "undefined" && MOCK_HISTORY[name] && MOCK_HISTORY[name].length) {
                rows = MOCK_HISTORY[name].slice().reverse(); // usa MOCK_HISTORY primeiro (10 itens)
            } else if (typeof history !== "undefined" && history[name] && history[name].length) {
                rows = history[name].slice().reverse();
            } else {
                for (let i = 0; i < 10; i++) {
                    const d = new Date(Date.now() - i * 60000);
                    rows.push({
                        time: d.toLocaleString(),
                        value: Number((Math.random() * (name === "Rede" ? 120 : 100)).toFixed(1))
                    });
                }
                rows = rows.reverse();
            }

            tbody.innerHTML = rows.map(h => {
                const status = getStatus(Number(h.value));
                const displayValue = (name === "Rede") ? `${h.value} MB/s` : `${h.value}%`;
                return `
            <tr>
              <td class="px-4 py-2 border-b">${h.time}</td>
              <td class="px-4 py-2 border-b">${displayValue}</td>
              <td class="px-4 py-2 border-b font-semibold text-${status.color}">
                ${status.text}
              </td>
            </tr>
        `;
            }).join("");

            modal.classList.remove("hidden");
        }



        function generateRandomHistoryForMissingReports(name) {
            const entries = [];
            for (let i = 0; i < 12; i++) {
                entries.push({
                    timestamp: new Date(Date.now() - i * 60000).toLocaleTimeString("pt-BR"),
                    value: (Math.random() * 100).toFixed(1)
                });
            }
            return entries.reverse();
        }

        function handleOutsideClick(event) {
            const modalContent = event.target.closest(".bg-white");
            const modal = document.getElementById("report-modal");
            if (!modalContent) closeModal();
        }

        function closeModal() {
            const modal = document.getElementById("report-modal");
            modal.classList.add("hidden");
            modal.removeEventListener("click", handleOutsideClick);
        }

        renderKPIs();

        function generateLabels(period) {
            if (period === "dia") return Array.from({ length: 24 }, (_, i) => `${i}h`);
            if (period === "semana") return ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
            return Array.from({ length: 30 }, (_, i) => `Dia ${i + 1}`);
        }

        function createChartElement(id) {
            const compName = components[id]; 
            return `
    <div class="bg-white p-6 rounded-xl border border-border">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-textPrimary">Gráfico Linha de ${compName}</h3>
        <button class="bg-gray-200 px-3 py-1 rounded-lg text-sm hover:bg-gray-300" onclick="openChartConfig(${id})">
          Configurar Gráfico
        </button>
      </div>
      <div id="chart-${id}" class="h-64 w-full"></div>
    </div>
  `;
        }




        function renderCharts() {
            const container = document.getElementById("charts-container");
            container.className = "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6";
            container.innerHTML = "";
            charts.length = 0;

            components.forEach((comp, i) => {
                container.innerHTML += createChartElement(i);
            });

            components.forEach((comp, i) => {
                activeComponents[i] = [comp]; 
                charts[i] = initApexChart(`chart-${i}`, activeComponents[i], "mês");
            });

        }


        function getColor(c) {
            return {
                CPU: "#191dec",
                RAM: "#69acff",
                Disco: "#b230fc",
                Rede: "#ef32aa",
            }[c] || "#6B7280";
        }

        function randomData(points) {
            return Array.from({ length: points }, () => Math.floor(Math.random() * 100));
        }

        function initApexChart(elementId, comps, period) {
            const labels = generateLabels(period);

            const series = comps.map(c => ({
                name: c,
                data: randomData(labels.length),
                color: getColor(c)
            }));

            const options = {
                chart: {
                    type: 'area',
                    height: 320,
                    toolbar: { show: false },
                    zoom: { enabled: false },
                    events: {
                        beforeZoom: () => false
                    }
                },

                title: {
                    text: comps.join(" + "),
                    align: "left",
                    style: {
                        fontSize: "16px",
                        fontWeight: "600",
                        color: "#111827"
                    }
                },

                series: series,

                dataLabels: { enabled: false },

                tooltip: {
                    enabled: true,
                    shared: true,
                    intersect: false
                },

                xaxis: {
                    categories: labels,
                    labels: { style: { colors: "#6B7280" } }
                },

                yaxis: {
                    max: comps.includes("Rede") ? 150 : 100,
                    labels: {
                        style: { colors: "#6B7280" },
                        formatter: v => comps.includes("Rede") ? v + " MB/s" : v + "%"
                    }
                },

                stroke: {
                    curve: 'smooth',
                    width: 2
                },

                fill: {
                    opacity: 0.25,
                    type: 'solid'
                },

                legend: {
                    show: true,
                    position: "bottom",
                    horizontalAlign: "center",
                    labels: { colors: "#111827" },
                    fontSize: "14px"
                },

                annotations: {
                    yaxis: [
                        {
                            y: 75,
                            borderColor: '#EF4444',
                            strokeDashArray: 6,
                            label: {
                                text: '75%',
                                style: {
                                    color: '#EF4444',
                                    background: '#FFE4E6'
                                }
                            }
                        }
                    ]
                }

            };

            const chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
            chart.render();

            return chart;
        }

        function openChartConfig(id) {
            const existing = document.getElementById(`chart-config-${id}`);
            if (existing) existing.remove();

            const active = Array.isArray(activeComponents[id]) && activeComponents[id].length
                ? activeComponents[id]
                : [components[id]];

            const checksHtml = components
                .map(c => {
                    const checked = active.includes(c) ? "checked" : "";
                    return `<label class="block mb-2"><input type="checkbox" value="${c}" class="mr-2" ${checked}> ${c}</label>`;
                })
                .join("");

            const modal = document.createElement("div");
            modal.id = `chart-config-${id}`;
            modal.className = "modal";
            modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-md p-6">
      <h3 class="text-xl font-semibold mb-4 text-textPrimary">Configurar Gráfico ${id + 1}</h3>
      <div class="mb-4">
        <p class="font-semibold text-textSecondary mb-2">Componentes</p>
        ${checksHtml}
      </div>
      <div class="mb-4">
        <p class="font-semibold text-textSecondary mb-2">Período</p>
        <select class="w-full border border-gray-300 rounded-lg p-2" id="period-${id}">
          <option value="dia">Último dia</option>
          <option value="semana">Última semana</option>
          <option value="mês" selected>Último mês</option>
        </select>
      </div>
      <div class="flex justify-end space-x-2">
        <button id="apply-btn-${id}" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-700">Aplicar</button>
        <button id="close-btn-${id}" class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-700">Fechar</button>
      </div>
    </div>
  `;
            document.body.appendChild(modal);

            modal.addEventListener("click", (e) => {
                const modalContent = e.target.closest(".bg-white");
                if (!modalContent) closeChartConfig(id);
            });

            document.getElementById(`apply-btn-${id}`).addEventListener("click", () => applyChartConfig(id));

            document.getElementById(`close-btn-${id}`).addEventListener("click", () => closeChartConfig(id));
        }

        function closeChartConfig(id) {
            const modal = document.getElementById(`chart-config-${id}`);
            if (modal) modal.remove();
        }

        function applyChartConfig(id) {
            const modal = document.getElementById(`chart-config-${id}`);
            if (!modal) return;

            const checked = Array.from(modal.querySelectorAll("input[type='checkbox']:checked"))
                .map(i => i.value);

            const periodSelect = modal.querySelector(`#period-${id}`);
            const period = periodSelect ? periodSelect.value : "mês";

            activeComponents[id] = checked.length ? checked : [components[id]];

            if (charts[id] && typeof charts[id].destroy === "function") {
                try { charts[id].destroy(); } catch (e) { /* ignore */ }
            }

            charts[id] = initApexChart(`chart-${id}`, activeComponents[id], period);

            const titleElement = document.getElementById(`chart-title-${id}`);
            if (titleElement) {
                titleElement.textContent = `Gráfico Linha de ${activeComponents[id].join(" + ")}`;
            }

            closeChartConfig(id);
        }


        renderCharts();

        document.addEventListener("DOMContentLoaded", () => {
            const dashboardBtn = document.getElementById("dashboardBtn");
            const dashboardMenu = document.getElementById("dashboardMenu");
            const dashboardArrow = document.getElementById("dashboardArrow");

            if (dashboardBtn && dashboardMenu && dashboardArrow) {
                let menuOpen = false;

                dashboardBtn.addEventListener("click", () => {
                    menuOpen = !menuOpen;

                    dashboardMenu.style.maxHeight = menuOpen
                        ? dashboardMenu.scrollHeight + "px"
                        : "0px";

                    dashboardArrow.classList.toggle("rotate-180", menuOpen);
                });
            }
        });

    </script>

</body>

</html>