<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoramento</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <link rel="stylesheet" href="./css/navbar.css">
    <link rel="icon" href="./assets/imgs/mini_logo_icon.png">

    <style>
        :root {
            --primary-red: #dc3545;
            --primary-red-darker: #b02a37;
            --sidebar-text: #ffffff;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 80px;
            --navbar-height: 70px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        #sidebar-container {
            z-index: 1031;
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 0.5rem 1.5rem;
            z-index: 1030;
            position: fixed;
            top: 0;
            right: 0;
            height: var(--navbar-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding-left: calc(var(--sidebar-width) + 1.5rem);
            transition: padding-left 0.3s ease-in-out;
        }

        body.sidebar-collapsed .navbar {
            padding-left: calc(var(--sidebar-collapsed-width) + 1.5rem);
        }

        #main-content {
            padding-top: calc(var(--navbar-height) + 20px);
            padding-left: var(--sidebar-width);
            padding-right: 0;
            transition: padding-left 0.3s ease-in-out;
            min-height: 100vh;
        }

        body.sidebar-collapsed #main-content {
            padding-left: var(--sidebar-collapsed-width);
        }

        @media (max-width: 992px) {

            #main-content,
            body.sidebar-collapsed #main-content {
                padding-left: 0;
            }

            .navbar,
            body.sidebar-collapsed .navbar {
                padding-left: 1.5rem;
                width: 100%;
            }
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s, stroke 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .transition-height {
            transition: max-height 0.28s ease;
        }
    </style>
</head>

<body>
    <div id="sidebar-container"></div>

    <nav class="navbar">
        <div style="display: flex; align-items: center;">
            <button class="btn" type="button" id="sidebar-toggle">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-slate-800 ml-4 hidden sm:block">Dashboard de Monitoramento</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="#" style="color: #64748b;"><i class="fas fa-bell fa-lg"></i></a>
            <img src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User Avatar" class="user-avatar">
        </div>
    </nav>

    <div id="main-content">
        <div class="p-6 md:p-8">

            <header class="mb-8">
                <h1 class="text-3xl font-bold text-textPrimary">Visão Geral</h1>
                <p class="text-textSecondary mt-1">Visão objetiva do estado dos seus componentes de servidor.</p>
            </header>

            <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8"></div>

            <div id="external-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md bg-white">
                    <div class="bg-success text-white text-center py-2 font-semibold text-lg">Padrão Operacional</div>
                    <div class="bg-white p-4 flex flex-col items-center justify-center">
                        <p class="text-lg font-semibold text-textPrimary mb-1">Normal</p>
                        <div class="flex flex-col items-center mt-4 mb-6">
                            <span class="material-symbols-outlined text-success text-4xl mb-2">schedule</span>
                            <p class="text-sm font-semibold text-textPrimary text-center">Hoje é Segunda — Carga
                                histórica alta</p>
                            <p class="text-sm text-textSecondary mt-1 text-center">Horário atual costuma apresentar
                                maior volume</p>
                        </div>
                        <button onclick="showReport('Padrão Operacional')"
                            class="bg-success text-white px-4 py-2 rounded-lg text-sm font-semibold">Exibir
                            Relatório</button>
                    </div>
                </div>
                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md bg-white">
                    <div class="bg-success text-white text-center py-2 font-semibold text-lg">Ônibus Ativos</div>
                    <div class="bg-white p-4 flex flex-col items-center justify-center">
                        <p class="text-lg font-semibold text-textPrimary mb-1">Normal</p>
                        <p class="text-sm text-textSecondary mb-2">Atualizado agora</p>
                        <div class="flex flex-col items-center mt-0 mb-4">
                            <p class="text-5xl font-extrabold leading-tight -mt-1">15</p>
                            <p class="text-sm font-semibold text-textPrimary mt-0">ônibus ativos</p>
                            <p class="text-sm text-textSecondary mt-1">Média para este horário: 14</p>
                        </div>
                        <button onclick="showReport('Ônibus Ativos')"
                            class="bg-success text-white px-4 py-2 rounded-lg text-sm font-semibold">Exibir
                            Relatório</button>
                    </div>
                </div>
                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md bg-white">
                    <div class="bg-danger text-white text-center py-2 font-semibold text-lg">Comparação Carga</div>
                    <div class="bg-white p-4 flex flex-col items-center justify-center">
                        <p class="text-lg font-semibold text-textPrimary mb-1">Crítico</p>
                        <p class="text-sm text-textSecondary mb-4">Atualizado agora</p>
                        <div class="flex flex-col items-center mt-4 mb-6">
                            <p class="text-4xl font-extrabold text-danger flex items-center gap-1">
                                +35% <span class="material-symbols-outlined text-4xl">arrow_upward</span>
                            </p>
                            <p class="text-sm text-textSecondary mt-1">Acima do esperado</p>
                        </div>
                        <button onclick="showReport('Comparação de Carga')"
                            class="bg-success text-white px-4 py-2 rounded-lg text-sm font-semibold">Exibir
                            Relatório</button>
                    </div>
                </div>
            </div>

            <div id="report-modal" class="hidden modal">
                <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-lg p-6">
                    <h3 id="modal-title" class="text-xl font-bold mb-4 text-textPrimary"></h3>
                    <table class="w-full border border-gray-200 rounded-lg mb-4">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left px-4 py-2">Data/Hora</th>
                                <th class="text-left px-4 py-2">Uso (%)</th>
                                <th class="text-left px-4 py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="modal-table-body"></tbody>
                    </table>
                    <button onclick="closeModal()"
                        class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Fechar</button>
                </div>
            </div>

            <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>

        </div>
    </div>

    <script src="./js/navbar.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { success: "#10B981", warning: "#F59E0B", danger: "#DC2626", surface: "#FFFFFF", border: "#E5E7EB", textPrimary: "#111827", textSecondary: "#6B7280" }, fontFamily: { display: ["Inter", "sans-serif"] } } },
        };

        let activeComponents = [];
        const components = ["CPU", "RAM", "Disco", "Rede"];
        const history = { CPU: [], RAM: [], Disco: [], Rede: [] };
        const charts = [];

        function generateUsage() { return Math.floor(Math.random() * 100); }
        function generateNetworkMB() {
            return Math.round((Math.random() * 120).toFixed(1));
        }

        function getStatus(usage) {
            if (usage < 70) return { text: "Normal", color: "success" };
            if (usage < 90) return { text: "Alerta", color: "warning" };
            return { text: "Crítico", color: "danger" };
        }

        function addHistory(name, value) {
            const now = new Date();
            const timestamp = now.toLocaleString();
            history[name].push({ time: timestamp, value });
            if (history[name].length > 10) history[name].shift();
        }

        function createKPI(name, usage) {
            const status = getStatus(usage);

            const colorClasses = {
                success: "bg-success text-white",
                warning: "bg-warning text-white",
                danger: "bg-danger text-white",
            };

            const apexColors = {
                success: "#10B981",
                warning: "#F59E0B",
                danger: "#EF4444"
            };

            const lastUpdate = history[name].length
                ? history[name][history[name].length - 1].time
                : "—";

            const chartId = `radial-${name}-${Math.floor(Math.random() * 999999)}`;

            setTimeout(() => {
                var usoOptions = {
                    series: [usage],
                    chart: {
                        type: 'radialBar',
                        height: 200,
                    },
                    colors: [apexColors[status.color]],
                    plotOptions: {
                        radialBar: {
                            startAngle: -135,
                            endAngle: 135,
                            min: 0,
                            max: 100,
                            hollow: {
                                margin: 15,
                                size: '75%',
                                background: 'transparent',
                            },
                            track: {
                                background: '#F3F4F6',
                                strokeWidth: '100%',
                                margin: 0,
                            },
                            dataLabels: {
                                name: {
                                    show: true,
                                    color: '#6B7280',
                                    fontSize: '14px',
                                    offsetY: 20
                                },
                                value: {
                                    formatter: function (val) {
                                        return (name === "Rede") ? val + " MB/s" : val + "%";
                                    },
                                    color: '#111827',
                                    fontSize: '28px',
                                    fontWeight: 'bold',
                                    offsetY: -10
                                }
                            }
                        }
                    },
                    labels: ['Utilizado'],
                    stroke: { lineCap: 'round' }
                };

                var chart = new ApexCharts(document.querySelector(`#${chartId}`), usoOptions);
                chart.render();
            }, 20);

            return `
    <div class="rounded-xl border border-gray-200 overflow-hidden shadow-md">
      <div class="${colorClasses[status.color]} text-center py-2 font-semibold text-lg">${name}</div>
      <div class="bg-white p-4 flex flex-col items-center justify-center">
        <p class="text-lg font-semibold text-textPrimary mb-1">${status.text}</p>
        <p class="text-sm text-textSecondary mb-4">Última atualização ${lastUpdate}</p>

        <div id="${chartId}" class="w-full flex justify-center"></div>

        <button onclick="showReport('${name}')" class="bg-${status.color} text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition">
          Exibir Relatório
        </button>
      </div>
    </div>`;
        }

        function renderKPIs() {
            const container = document.getElementById("kpi-container");
            container.innerHTML = "";
            components.forEach((c) => {
                const usage = (c === "Rede") ? generateNetworkMB() : generateUsage();
                addHistory(c, usage);
                container.innerHTML += createKPI(c, usage);
            });
        }

        function showReport(name) {
            const modal = document.getElementById("report-modal");
            const title = document.getElementById("modal-title");
            const tbody = document.getElementById("modal-table-body");
            if (!modal || !title || !tbody) return;

            title.textContent = `Relatório de ${name}`;
            const ths = modal.querySelectorAll("th");
            if (ths && ths.length >= 2) ths[1].textContent = (name === "Rede") ? "Uso (MB/s)" : "Uso (%)";

            let rows = [];
            const dataSrc = history[name] && history[name].length > 0 ? history[name].slice().reverse() : [];
            if (dataSrc.length === 0) {
                for (let i = 0; i < 10; i++) {
                    const d = new Date(Date.now() - i * 60000);
                    rows.push({ time: d.toLocaleString(), value: Math.floor(Math.random() * 100) });
                }
            } else { rows = dataSrc; }

            tbody.innerHTML = rows.map(h => {
                const val = Number(h.value);
                const status = getStatus(val);
                return `<tr><td class="px-4 py-2 border-b">${h.time}</td><td class="px-4 py-2 border-b">${h.value}%</td><td class="px-4 py-2 border-b font-semibold text-${status.color}">${status.text}</td></tr>`;
            }).join("");
            modal.classList.remove("hidden");
        }

        function closeModal() {
            const modal = document.getElementById("report-modal");
            if (modal) modal.classList.add("hidden");
        }

        function generateLabels(period) {
            if (period === "dia") return Array.from({ length: 24 }, (_, i) => `${i}h`);
            if (period === "semana") return ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
            return Array.from({ length: 30 }, (_, i) => `Dia ${i + 1}`);
        }

        function createChartElement(id) {
            const compName = components[id];
            return `
            <div class="bg-white p-6 rounded-xl border border-border shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-textPrimary" id="chart-title-${id}">Gráfico Linha de ${compName}</h3>
                    <button class="bg-gray-200 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 text-gray-700" onclick="openChartConfig(${id})">Configurar Gráfico</button>
                </div>
                <div id="chart-${id}" class="h-64 w-full"></div>
            </div>`;
        }

        function renderCharts() {
            const container = document.getElementById("charts-container");
            container.innerHTML = "";
            components.forEach((comp, i) => { container.innerHTML += createChartElement(i); });
            components.forEach((comp, i) => {
                activeComponents[i] = [comp];
                charts[i] = initApexChart(`chart-${i}`, activeComponents[i], "mês");
            });
        }

        function getColor(c) {
            return { CPU: "#191dec", RAM: "#69acff", Disco: "#b230fc", Rede: "#ef32aa" }[c] || "#6B7280";
        }

        function randomData(points) {
            return Array.from({ length: points }, () => Math.floor(Math.random() * 100));
        }

        function initApexChart(elementId, comps, period) {
            const labels = generateLabels(period);
            const series = comps.map(c => ({ name: c, data: randomData(labels.length), color: getColor(c) }));
            const options = {
                chart: { type: 'area', height: 320, toolbar: { show: false }, zoom: { enabled: false } },
                series: series,
                dataLabels: { enabled: false },
                tooltip: { enabled: true, shared: true, intersect: false },
                xaxis: { categories: labels, labels: { style: { colors: "#6B7280" } } },
                yaxis: { max: comps.includes("Rede") ? 150 : 100, labels: { style: { colors: "#6B7280" }, formatter: v => comps.includes("Rede") ? v + " MB/s" : v + "%" } },
                stroke: { curve: 'smooth', width: 2 },
                fill: { opacity: 0.25, type: 'solid' },
                legend: { show: true, position: "bottom" },
                annotations: { yaxis: [{ y: 75, borderColor: '#EF4444', strokeDashArray: 6, label: { text: '75%', style: { color: '#EF4444', background: '#FFE4E6' } } }] }
            };
            const chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
            chart.render();
            return chart;
        }

        function openChartConfig(id) {
            const existing = document.getElementById(`chart-config-${id}`);
            if (existing) existing.remove();

            const active = Array.isArray(activeComponents[id]) && activeComponents[id].length ? activeComponents[id] : [components[id]];
            const checksHtml = components.map(c => {
                const checked = active.includes(c) ? "checked" : "";
                return `<label class="block mb-2 text-gray-700"><input type="checkbox" value="${c}" class="mr-2" ${checked}> ${c}</label>`;
            }).join("");

            const modal = document.createElement("div");
            modal.id = `chart-config-${id}`;
            modal.className = "modal";
            modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-textPrimary">Configurar Gráfico ${id + 1}</h3>
                <div class="mb-4"><p class="font-semibold text-textSecondary mb-2">Componentes</p>${checksHtml}</div>
                <div class="mb-4">
                    <p class="font-semibold text-textSecondary mb-2">Período</p>
                    <select class="w-full border border-gray-300 rounded-lg p-2 text-gray-700" id="period-${id}">
                        <option value="dia">Último dia</option>
                        <option value="semana">Última semana</option>
                        <option value="mês" selected>Último mês</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="apply-btn-${id}" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-700">Aplicar</button>
                    <button id="close-btn-${id}" class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-700">Fechar</button>
                </div>
            </div>`;
            document.body.appendChild(modal);

            modal.addEventListener("click", (e) => {
                const modalContent = e.target.closest(".bg-white");
                if (!modalContent) closeChartConfig(id);
            });
            document.getElementById(`apply-btn-${id}`).addEventListener("click", () => applyChartConfig(id));
            document.getElementById(`close-btn-${id}`).addEventListener("click", () => closeChartConfig(id));
        }

        function closeChartConfig(id) {
            const modal = document.getElementById(`chart-config-${id}`);
            if (modal) modal.remove();
        }

        function applyChartConfig(id) {
            const modal = document.getElementById(`chart-config-${id}`);
            if (!modal) return;

            const checked = Array.from(modal.querySelectorAll("input[type='checkbox']:checked")).map(i => i.value);
            const periodSelect = modal.querySelector(`#period-${id}`);
            const period = periodSelect ? periodSelect.value : "mês";

            activeComponents[id] = checked.length ? checked : [components[id]];

            if (charts[id] && typeof charts[id].destroy === "function") {
                try { charts[id].destroy(); } catch (e) { }
            }

            charts[id] = initApexChart(`chart-${id}`, activeComponents[id], period);
            const titleElement = document.getElementById(`chart-title-${id}`);
            if (titleElement) titleElement.textContent = `Gráfico Linha de ${activeComponents[id].join(" + ")}`;

            closeChartConfig(id);
        }

        renderKPIs();
        renderCharts();

        if (typeof lucide !== 'undefined') lucide.createIcons();
    </script>
</body>

</html>